---
title: "MyFoodPrint survey analysis"
author: "Remco Benthem de Grave"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
# knitr::opts_knit$set(root.dir = '..')
```

```{r}
library(tidyverse)
library(magrittr)
library(psych) #describe.by function
library(pastecs) #stat.desc function (normality check)
library(here) 
library(lattice) #desityplot function
library(hrbrthemes) #ggplot themes, e.g. theme_ipsum
# library(reporttools) #latex code for table with date descriptives
library(summarytools) #package that can help with descriptive statistics if it includes dates
library(gridExtra) #plots side by side
library(cowplot) #plots side by side and allows changing relative size
library(gt) # (grammar tables) nice tables directly for publication or Latex
library(gtExtras) #extension to gt to allow e.g. graphs in plots
library(gtsummary) #extension to gt to automate summary tables
```


```{r message=FALSE}
#load survey data and convert to factors
survey_data_all <- read_csv(here("survey_analysis","datasets","processed","survey_data_all.csv"))

survey_data_all_wide <- read_csv(here("survey_analysis","datasets","processed","survey_data_all_wide.csv"))


# convert to factors
source(here("survey_analysis","preprocessing_scripts","convert_to_factor.R"))
```


# Survey analyses

## Descriptives

### Survey meta data



TO DO: study meta data: start date, end date (range, median), study duration (range, median, IQR?) -- mention 2 participants having a break.
Survey meta: duration of survey, number of questions. 
Duration of interviews.

demographics
...

TO DO: compare barriers before and after

Demographics

#### Variation in study start and end dates of participants (as measured by the time of taking the survey)

```{r}
#make a descriptive table of survey dates
survey_data_all %>% 
    rename(survey_date = StartDate) %>% #a better description 
    mutate(across(where(~ is.POSIXct(.)), as.numeric)) %>% #to calculate distributions, we need numeric data
    mutate(across(survey_id, ~ case_match(., "T1 (start)" ~ "start", "T2 (end)" ~ "end"))) %>% #these will become the variable names
    mutate(across(survey_id, ~ factor(., levels = c("start","end"),ordered = T))) %>%
    group_by(survey_id) %>% 
    summarise( #creating the descriptive stats
      across(
        .cols = contains("date"), 
        .fns = list(
          median = ~ as_datetime(median(.x, na.rm = TRUE)), 
          IQR = ~ IQR(.x / as.numeric(ddays(1)), na.rm = TRUE) %>% round(digits = 2), #%>% paste('days')
          min = ~ as_datetime(min(.x, na.rm = TRUE)),
          max = ~ as_datetime(max(.x, na.rm = TRUE)),
          distribution = ~ list(.x) #we will create the distribution graph in a next step
        ),
        .names = "{.fn}"
      )
    ) %>%
    #add a group name so that we can have a row group that we can target for the footnote
    add_column(data_group = "Study period") %>%
    group_by(data_group) %>%
    # #turning the survey_id to the row label
    # column_to_rownames(var = "survey_id") %>%
    #creating the gt table
    gt(rowname_col = "survey_id") %>%
    fmt_date( #format the date display style
      columns = where(~ is.POSIXct(.)),
      rows = everything(),
      date_style = "day_m_year",
      pattern = "{x}",
      locale = NULL
    ) %>%
    fmt_duration( #format the period style 
      columns = contains("date_IQR"),
      input_units = "days",
      output_units = "days",
      duration_style = "wide"
    ) %>%
    #creating the distribution graph
    gt_plt_dist(contains("distribution"), type = "boxplot", same_limit = T) %>%
    #add footnote that the start and end date are determined by the date of doing the start/end survey
    tab_footnote(
      footnote = md("Study start and end dates are defined here by the date the participant completed the start and end surveys."),
      locations = cells_stub(rows = everything()))
```

```{r}
#make a descriptive table of survey dates
survey_data_all_wide %>% 
    select(study_duration) %>%
    summarise( #creating the descriptive stats
      across(
        .cols = everything(), 
        .fns = list(
          median = ~ (median(.x, na.rm = TRUE)), 
          IQR = ~ IQR((.x), na.rm = TRUE), 
          min = ~ (min(.x, na.rm = TRUE)),
          max = ~ (max(.x, na.rm = TRUE)),
          distribution = ~ list(.x) #we will create the distribution graph in a next step
        ),
        .names = "{.fn}"
      )
    ) %>%
    #reduce to 1 decimal
    mutate(
      across(
        median:max, ~ round(.x, digits = 1)
      )
    ) %>%
  
    #add a group name so that we can have a row group that we can target for the footnote
    add_column(rowname = "Duration (days)") %>%
    #creating the gt table
    gt(rowname_col = "rowname") %>%
    #creating the distribution graph
    gt_plt_dist(contains("distribution"), type = "boxplot", same_limit = T) 
```

```{r}
# TO DO: study meta data: start date, end date (range, median), study duration (range, median, IQR?) -- mention 2 participants having a break.
# Survey meta: duration of survey, number of questions. 
survey_data_all_wide %>% 
  select(contains(c("survey_date","study_duration","survey_duration"))) %>% 
  dfSummary()


#participants started the receipt scanning period over a range of two weeks, between 2023-04-24 and 2023-05-09 and finished this period between 2023-05-17 and 2023-06-09 (~3 week spread). Receipt scanning periods ranged from x to x weeks, with two participants extending to ~ 4 weeks participation, due to a 1-week vacation abroad. Receipts were scanned between ... and .... [?most receipts were scanned early during the study period, with xx% of receipts scanned in the first week after onboarding... with the median receipt scanning date on ...]. 

```


In a density plot:
```{r}
#graph of distribution of start dates
survey_data_all %>% 
  ggplot(aes(x=StartDate,color=survey_id)) +
  geom_density(position = "identity") +
  geom_point(y=0,shape=4) +
  theme_ipsum() +
  labs(x = "Survey", y="Date")
```

In a box plot:

```{r}

##TRY PUTTING TWO GRAPHS IN ONE USING ... MULTIPLOT?
#graph of distribution of start dates
p1 <- survey_data_all %>% 
  arrange((survey_id)) %>% 
  ggplot(aes(x=survey_id,y=StartDate)) +
  geom_boxplot() + 
  geom_jitter(color="black", size=0.4, alpha=0.9, shape=3) +
  # facet_wrap(.~survey_id, scales = "free") + 
  theme_ipsum() +
  labs(x = "Survey", y="Date")

# #because of the extreme outlier, we want to note this one only as a text and reduce the scale of the graph
# #graph of distribution of start dates
# 
# 
# #move outlier to separate column
# graphData <- 
#   survey_data_all %>%
#   mutate(
#     duration_outlier = 
#       ifelse(
#         abs(duration_min) > quantile(abs(duration_min),.99), 
#         duration_min,
#         NA
#       ),
#   .after = duration_min)
# 
# #now replace the outlier by NA 
# graphData %<>%
#   mutate(
#     duration_min = 
#       ifelse(
#         abs(duration_min) < quantile(abs(duration_min),.99), 
#         duration_min,
#         NA
#       )
#     )

p2 <- survey_data_all %>% 
  arrange((survey_id)) %>% 
  ggplot(aes(x=survey_id,y=duration_min)) +
  geom_boxplot() + 
  geom_jitter(color="black", size=0.4, alpha=0.9, shape=3) +
  # facet_wrap(.~survey_id, scales = "free") + 
  theme_ipsum() +
  labs(x = "Survey", y="Survey duration (mins)") + 
  scale_y_log10()

#study duration
p3 <- survey_data_all_wide %>%
  ggplot(aes(y=study_duration, x = "")) +
  geom_boxplot() + 
  geom_jitter(color="black", size=0.4, alpha=0.9, shape=3) +
  theme_ipsum() +
  labs(x = "", y="Study duration (days)")# + 
  # scale_y_log10()

#MAY NEED EXTRA GRID INSTEAD
w = 19/50
plot_grid(p1, p2, p3, align = "h", ncol = 3, rel_widths = c(w, w, (1-2*w)))
plot_grid(plotlist = list(p1, p2, p3), align = "h", ncol = 3, rel_widths = c(w, w, (1-2*w)))
```

### Participant demographics


```{r}
survey_data_all_wide %>%
  select(age:apps_used) %>%
  dfSummary()
```

```{r fig.height=8}
#graphical presentation of participant demographics

#some factors are really long and need to be relabeled so that all can fit
survey_data_all_wide$degree %<>% fct_relabel(~ gsub(" \\(high school diploma or equivalent including GED\\)","", .x))

#adults and children need to be turned into factors for better representation
survey_data_all_wide$children %<>% factor(., levels = c('0','1','2'))

graphs <- 
  survey_data_all_wide %>% 
  select(age:diet) %>%
  #for each column (variable) in the data frame we want the data (.x) and the name (.y) 
  map2(.x = ., .y = names(.), ~ ggplot(data = survey_data_all_wide, aes(x=.x)) + 
        geom_bar() + 
        labs(x = "",y = "", title = str_replace_all(.y,"_"," ")) +
         coord_flip()
      )

plot_grid(plotlist = graphs, align = "v", ncol = 2)

#probably better as a faceted ggplot. However, need to assure that factors are maintained

```


```{r}
#attempt to do the above as a faceted graph

#define the columns we want to plot (we need this data on several instances, e.g. also to organise the output)
plot_cols <- survey_data_all_wide %>% select(share_store:`share_out-of-home`) %>% names(.)

survey_data_all_wide %>% 
    #this is household level information, so we take this data only from the primary household member (as identified by the number of contributed receipts).
  filter(primary == "primary") %>%
  select(user_ID,matches(plot_cols)) %>%
  #ggplot needs the data in long format. Because it has consistent factor levels throughout this works
  pivot_longer(cols = share_store:`share_out-of-home`, names_to = "variable", values_to = "frequency") %>%
  #turn 'variable' into a factor, so it is organised as it appears in the original data
  mutate(variable = factor(variable, levels = plot_cols)) %>% 
  # #we want to replace the underscores by white spaces
  # mutate((frequency = fct_relabel(frequency, ~ gsub("_"," ", .x)))) %>%
  
  ggplot(aes(x=frequency)) + 
    geom_bar() + 
    facet_wrap(
      .~variable, 
      #replace the underscores in the facet labels
      labeller = as_labeller(setNames(as.character(str_replace_all(plot_cols,"_"," ")),as.character(plot_cols)))
    ) + 
    coord_flip() + 
    stat_count(
      geom = "label", 
      # colour = "white", 
      size = 3.5,
      aes(label = after_stat(count)),
      position=position_stack(vjust=1)
    ) +
    theme_ipsum() +
    labs(x = "", y="") + 
    ggtitle("Where you get your food from?")



```
##### Other sources for food acquisition

```{r}
#now lets also plot how many households got food from other sources then the default 6
#we use a donut chart. This requires percentages in the data and defined values of top and bottom of each slice
graph_data <- survey_data_all_wide %>%
  filter(primary == "primary") %>%
  count(share_other) %>%
  #in percentages
  mutate(ratio = n/sum(n)) %>%
  #top of each rectangle of
  mutate(ymax = cumsum(ratio)) %>%
  #bottom of each rectangle 
  mutate(ymin = c(0,head(ymax, n=-1))) %>%
  #add data for a slice label
  mutate(label = paste0(share_other,": ",n,"\n (",round(ratio * 100),"%)")) %>%
  #position data to center the label
  mutate(label_position = (ymin+ymax)/2)

#lets plot
graph_data %>%
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=2, xmin=0, fill=share_other)) +
    geom_rect() + 
    coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
    xlim(c(-2, 2)) + # By setting a lower xmin for the displayed axis, we create the gap in the center
    geom_label( x=1, aes(y=label_position, label=label), size=5) + 
    theme_void() +
    theme(legend.position = "none") + 
    ggtitle("Acquiring food through other sources")

#and create a list of these sources

survey_data_all_wide %>%
  filter(primary == "primary") %>% 
  filter(!is.na(other_def)) %>%
  select(other_def) %>%
  mutate(across(other_def, ~ str_to_sentence(.))) %>% 
  rename(`Descriptions of other food sources` = other_def) %>%
  #create the table
  gt() %>%
  #change the border style inbetween rows
  tab_style(
    style = cell_borders(
      sides = c("top", "bottom"),
      color = "white",
      weight = px(1.5),
      style = "solid"
    ),
    locations = cells_body()
  ) %>%
  # #smaller text inside cell
  # tab_style(
  #   style = cell_text(size = "small"),
  #   locations = cells_body()
  # ) %>% 
  #reduce padding around cells
  tab_options(data_row.padding = px(3)) %>%
  #add a footnote explaining 'other food sources'
  tab_footnote(footnote = md("If participants selected *yes* on the previous question, they could provide a free-text description of these food sources."),
                 locations = cells_column_labels(columns = `Descriptions of other food sources`))

```


##### Where do people get their groceries from

```{r}
densityplot(survey_data_all$age)
```

```{r}
#check for reporting paired t-test and independent t-test. t-stat, p, effect size; 95%-CI range; interpretation of scale
#bar-chart for ordinal scales. use integer levels of factors and describe the scores in the caption
```

## Distribution of ordinal data

### Disagree-Agree scale answers

```{r}
## APPROACH: grid like heatmap with percentage count and color -- like correlation plot. Shortname and question on the horizontal. 7 levels on the vertical. ~ table grid with colors

# Attitudes 1 (T1): I think of myself as a person who cares for the environmental.
# Attitudes 1 (T2): I think of myself as a person who cares for the environmental.
# Attitudes 2 (T1): To engage in environmentally sustainable behaviours is an important part of who I am.
# Attitudes 2 (T2): To engage in environmentally sustainable behaviours is an important part of who I am.
# Attitudes 3 (T1): I am NOT the kind of person who makes efforts to conserve the environment.
# Attitudes 3 (T2): I am NOT the kind of person who makes efforts to conserve the environment.
# Attitudes 4 (T1): In my daily life I try to find ways to minimize my impact on the environment.
# Attitudes 4 (T2): In my daily life I try to find ways to minimize my impact on the environment.
# Self-Efficacy 1 (T1): I feel that I can make a difference by paying attention to the footprint of my groceries
# Self-Efficacy 1 (T2): I feel that I can make a difference by paying attention to the footprint of my groceries
# Self-Efficacy 2 (T1): I feel that I know how to go about pursuing a low foodprint.
# Self-Efficacy 2 (T2): I feel that I know how to go about pursuing a low foodprint.
# Self-Efficacy 3 (T1): I feel capable to pursue a low foodprint.
# Self-Efficacy 3 (T2): I feel capable to pursue a low foodprint.
# Spill-over 1: Over the last weeks I have become more attentive to environmental issues unrelated to the MyFoodPrint app.
# Spill-over 2: Over the last week I feel I have become more inclined to engage in environmental sustainablility matters unrelated to the MyFoodPrint app.
# Impact 1: The app helped me in my environmental goals.
# Impact 2: The app made me feel more in control of my foodprint.
# Impact 3: The app helped me change my purchase behaviour.

ratings_table_labels <- 
  c(
    "Attitudes 1 (T1): I think of myself as a person who cares for the environmental.",
    "Attitudes 1 (T2): I think of myself as a person who cares for the environmental.",
    "Attitudes 2 (T1): To engage in environmentally sustainable behaviours is an important part of who I am.",
    "Attitudes 2 (T2): To engage in environmentally sustainable behaviours is an important part of who I am.",
    "Attitudes 3 (T1): I am NOT the kind of person who makes efforts to conserve the environment.",
    "Attitudes 3 (T2: I am NOT the kind of person who makes efforts to conserve the environment.",
    "Attitudes 4 (T1): In my daily life I try to find ways to minimize my impact on the environment.",
    "Attitudes 4 (T2): In my daily life I try to find ways to minimize my impact on the environment.",
    "Self-Efficacy 1 (T1): I feel that I can make a difference by paying attention to the footprint of my groceries.",
    "Self-Efficacy 1 (T2): I feel that I can make a difference by paying attention to the footprint of my groceries.",
    "Self-Efficacy 2 (T1): I feel that I know how to go about pursuing a low foodprint.",
    "Self-Efficacy 2 (T2): I feel that I know how to go about pursuing a low foodprint.",
    "Self-Efficacy 3 (T1): I feel capable to pursue a low foodprint.",
    "Self-Efficacy 3 (T2): I feel capable to pursue a low foodprint.",
    "Spill-over 1: Over the last weeks I have become more attentive to environmental issues unrelated to the MyFoodPrint app.",
    "Spill-over 2: Over the last week I feel I have become more inclined to engage in environmental sustainablility matters unrelated to the MyFoodPrint app.",
    "Impact 1: The app helped me in my environmental goals.",
    "Impact 2: The app made me feel more in control of my foodprint.",
    "Impact 3: The app helped me change my purchase behaviour."
  )

ratings_table_data <- 
  survey_data_all_wide %>%
  select(env_attitude_1_T1:SelfEff_3_T2, spillover_1:spillover_2,state_helped_goals:state_helped_change)

#map labels with variable names
ratings_table_labels <-
  tibble(shortname = names(ratings_table_data), label = ratings_table_labels)



#create gt table with questions(labels) as row names and percentages (colored background) for each of the 7 levels
#



#aggregate ratings
ratings_table <- 
  ratings_table_data %>% 
  pivot_longer(cols = everything(), names_to = "shortname", values_to = "response") %>% 
  group_by_all() %>% 
  count()
  # mutate(across(everything(), ~ ./n()))

#calculate number of answers per question
ratings_table %<>%
  group_by(shortname) %>%
  mutate(answers_n = sum(n))

#calculate percentage  
ratings_table %<>%
  mutate(perc = n/answers_n, .keep = "unused")

#for displaying, create a column per answer category
ratings_table %<>%
  pivot_wider(names_from = response, values_from = perc)

#ordering the answer columns according to the factor levels
ratings_table %<>% 
  relocate(
    contains(
      ratings_table_data %>% pull(1) %>% levels() #this line pulls the organised factors from the first variable (note that all the variables share the same factor levels)
    ), 
    .after = last_col()
  )

#replace NA by 0
ratings_table %<>% 
  mutate(
    across(
      where(is.numeric),
      ~ replace_na(.,0)
    )
  )

#include the label
ratings_table %<>% 
  left_join(ratings_table_labels,.)

#remove the shortname
ratings_table %<>% select(!shortname)

#separate elements of the label so we can use these for grouping
ratings_table %<>% 
  separate_wider_delim(cols = label , delim = ': ', names = c("shortname","question"))

ratings_table %<>% 
  separate_wider_delim(cols = shortname , delim = ' ', names = c("concept","question_nr","timepoint"), too_few = "align_start")

#remove the brackets around the time point label
ratings_table %<>% 
  mutate(timepoint = str_replace_all(timepoint,"[:punct:]",""))

#some questions only appeared in the T2 questionnaire. We didn't include a time point for those, but will do so now. 
ratings_table %<>% 
  mutate(timepoint = replace_na(timepoint,"T2 only"))

#merge the question number and question back again
ratings_table %<>% 
  mutate(question = paste(question_nr, question, sep = ": "), .keep = "unused")


#style that table 
ratings_table %>% 
  group_by(concept,timepoint) %>%
  gt(rowname_col = "question") %>%
  tab_spanner(
    label = "ratings",
    columns = `strongly disagree`:`strongly agree`
  ) %>%
  fmt_percent(
    columns = where(is.numeric),
    decimals = 0
  ) %>%
  data_color(
    method = "numeric",
    palette = c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab")
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(cells_column_labels(everything()),cells_row_groups(everything()))
  )

#for poster: use SE1, SE2, etc. and column labels 1:7 with footnote: 1 = strongly disagree, 7 = strongly agree
```

```{r}
# Intention 1: How likely are you to reduce your footprint over the next months?
# Intention 2: How inclined are you to attempt to reduce your footprint over the next months?

    "Intention 1: How likely are you to reduce your footprint over the next months?",
    "Intention 2: How inclined are you to attempt to reduce your footprint over the next months?",
```

## Visualizing composite results

```{r}
#adjustment dataset: rename the survey_id to before and after and make it into an ordinal factor
survey_data_all %<>% 
  mutate(
    survey_id = case_match(survey_id, "T1 (start)" ~ "before", "T2 (end)" ~ "after")
  ) %>%
  mutate(
    survey_id = factor(survey_id, levels = c("before","after"))
  )
```


Boxplots of differences in knowledge, self-efficacy and intention

```{r knowledge boxplot, fig.height=6, fig.width=3}}
survey_data_all %>% 
  
  #divide the score by 100 because it is a percentage. We will use a percentage axis
  mutate(knowledge_score = knowledge_score/100) %>%
  
  #create a boxplot
  ggplot(aes(x=survey_id, y=knowledge_score)) + 
  geom_boxplot(
    #manual color (green)
    fill = "#A1EEBD", #"#35b0ab",
    
    # Notch?
    notch=F,
    notchwidth = 0.8,
  ) + 
  
  #y axis in percentage
  scale_y_continuous(labels = scales::percent) +
  
  #no axis labels. Title only
  labs(x = "", y = "", title = "Foodprint knowledge") + 
  
  #style
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

#export the plot
ggsave(here("output","plots","knowledge_boxplot.png"), width = 3, height = 6)
```

```{r selfefficacy boxplot, fig.height=6, fig.width=3}}
survey_data_all %>% 
  
  #create a boxplot
  ggplot(aes(x=survey_id, y=SelfEff)) + 
  geom_boxplot(
    #manual color (yellow)
    fill = "#F6F7C4",  #"#f2fbd2",
    
    # Notch?
    notch=F,
    notchwidth = 0.8,
  ) + 
  
  #no axis labels. Title only
  labs(x = "", y = "", title = "Self-efficacy") + 
  
  #y-axis scale 1 to 7
  scale_y_continuous(limits = c(1,7), breaks = c(1,3,5,7)) +
  
  #style
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

#export the plot
ggsave(here("output","plots","selfefficacy.png"), width = 3, height = 6)
```

```{r intention boxplot, fig.height=6, fig.width=2}}
survey_data_all %>% 
  
  select(survey_id, intention) %>%
  filter(!is.na(intention)) %>%
  
  #create a boxplot
  ggplot(aes(x=survey_id, y=intention)) + 
  geom_boxplot(
    #manual color (blue)
    fill = "#7BD3EA",
    
    # Notch?
    notch=F,
    notchwidth = 0.8,
  ) + 
  
  #no axis labels. Title only
  labs(x = "", y = "", title = "Intention") + 
  
  #y-axis scale 1 to 7
  scale_y_continuous(limits = c(1,7), breaks = c(1,3,5,7)) +
  
  #style
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

#export the plot
ggsave(here("output","plots","intention.png"), width = 2, height = 6)
```

```{r spillover boxplot, fig.height=6, fig.width=2}}
survey_data_all %>% 
  
  select(survey_id, spillover) %>%
  filter(!is.na(spillover)) %>%
  
  #create a boxplot
  ggplot(aes(x=survey_id, y=spillover)) + 
  geom_boxplot(
    #manual color (red-orange)
    fill = "#F6D6D6",
    
    # Notch?
    notch=F,
    notchwidth = 0.8,
  ) + 
  
  #no axis labels. Title only
  labs(x = "", y = "", title = "Spillover") + 
  
  #y-axis scale 1 to 7
  scale_y_continuous(limits = c(1,7), breaks = c(1,3,5,7)) +
  
  #style
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

#export the plot
ggsave(here("output","plots","spillover.png"), width = 2, height = 6)
```

Boxplots of all the 7-point Lickert scale questions

```{r boxplot all composites}
#boxplot of all 7-point Lickert scale questions

survey_data_all %>% 
  
  #select the data
  select(survey_id, env_attitude, SelfEff, intention, spillover) %>% 
  
  #long format for ggplot
  pivot_longer(cols = !survey_id, names_to = "concept", values_to = "response") %>% 
  
  #make some concept names more legible
  mutate(
    concept = case_match(
      concept, 
      "env_attitude" ~ "Environmental attitude",
      "SelfEff" ~ "Self-efficacy",
      "intention" ~ "Intention",
      "spillover" ~ "Spillover"
    )
  ) %>%
  
  #remove NA responses (because some variables were not recorded at T1 (before))
  filter(!is.na(response)) %>%
  
  #create the boxplot
  ggplot(aes(x=concept, y=response, fill = survey_id)) + 
  geom_boxplot() + 
  
  # #separate facet for each concept
  # facet_wrap(~concept, scales = "free_x") +
  
  theme_minimal() + 
  
  labs(x = "", y = "", fill = "Time point")

```


```{r stats knowledge}
#aim: 
# - visually show knowledge at t1 and knowledge at t2
# - visually show difference from zero of knowledge change. CI of value
# - note: check distribution of knowledge values --> box plots as create by the table above --> use block below as a basis. First try the default gtable summary tool
# for variables: 
# maybe env_attitude_1_T1 to SelfEff_3_T2 --> these are ordinal!
# knowledge_1_score_T1 to knowledge_score_T2 --> all continuous
# intention:helpful --> all continuous

survey_data_all_wide %>%
  select(contains("knowledge")) %>%
  gt_plt_summary()

survey_data_all_wide %>%
  mutate(knowledge_gain = knowledge_score_T2 - knowledge_score_T1, .keep = "none") %>% 
  stat.desc(norm = T) 
#normally distributed

survey_data_all_wide %>%
  mutate(knowledge_gain = knowledge_score_T2 - knowledge_score_T1, .keep = "none") %>% 
  boxplot()

with(survey_data_all_wide, 
     t.test(knowledge_score_T2, knowledge_score_T1, paired = T, alternative = "greater")
     )

#https://www.datanovia.com/en/lessons/t-test-effect-size-using-cohens-d-measure/

#cohen-D
library(rstatix)

survey_data_all %>%  
  cohens_d(knowledge_score ~ survey_id, paired = TRUE)
#effect size: -0.83 (large effect size)
```

```{r stats self efficacy}
## self-efficacy

survey_data_all_wide %>%
  select(contains("SelfEff")) %>%
  gt_plt_summary()

survey_data_all_wide %>%
  mutate(efficacy_gain = SelfEff_T2 - SelfEff_T1, .keep = "none") %>% 
  stat.desc(norm = T) 
#normally distributed

survey_data_all_wide %>%
  mutate(efficacy_gain = SelfEff_T2 - SelfEff_T1, .keep = "none") %>% 
  boxplot()

with(survey_data_all_wide, 
     t.test(SelfEff_T2,SelfEff_T1, paired = T, alternative = "greater")
     )

#cohen-D
survey_data_all %>%  
  cohens_d(SelfEff ~ survey_id, paired = TRUE)
#effect size: -0.80 (large effect size)
```

```{r stats intention}

survey_data_all_wide %>%
  select(intention,spillover) %>% 
  stat.desc(norm = T) 
#normally distributed

with(survey_data_all_wide, 
     t.test(intention-4 , alternative = "greater")
     )

#cohen-D
survey_data_all %>%  
  cohens_d(intention ~ 1, mu = 4)
#effect size: 1.57 (large effect size)

with(survey_data_all_wide, 
     t.test(spillover-4 , alternative = "greater")
     )

#cohen-D
survey_data_all %>%  
  cohens_d(spillover ~ 1, mu = 4)
#effect size: 0.68 (moderate effect size)


```





make some graphs - barcharts of ratings; average knowledge etc + variance

```{r}
#bar charts of UX rating and help scores
#LOOK INTO: barchart different factor labels, seperated by facets
#BUT FIRST ONE CHART
#HORIZONAL STACKED BAR CHART; LABELS NEXT TO BAR? SEE NUSSBAUM
#INVESTIGATE HOW TO DO THE LEGEND. CAN IT BE COLORED TEXT? 
#MAYBE AS VERY MUCH A TO VERY MUCH BE. OR LABELS LEFT AND RIGHT OF GRAPH?
#VERY MUCH - TO VERY MUCH +
#VARIABLE NAME NEEDS TO BE PRESENTED AS E.G. OBSTRUCTIVE (-) / SUPPORTIVE (+)

surveyT2 %>% 
  select()
  ggplot(
    aes()
  )

```

how to do this fast. get some fast graphs/statistics -->
horizonal bars of averages

```{r}
surveyT2 %>% 
  select(env_attitude:knowledge_score) %>%
  mutate(knowledge_score = knowledge_score*7/100) %>%
  pivot_longer(cols = everything()) %>%
  ggplot(
    aes(y = name, x = value)
  ) +
  geom_boxplot()

```



